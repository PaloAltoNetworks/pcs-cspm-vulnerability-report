# Prisma Cloud Vulnerabiltiies Report
This script is meant to generate a vulnerabilities report of Prisma Cloud using a vulnerability query.

This script can be run on your local machine or in a CI/CD pipeline, like the [workflow](https://github.com/PaloAltoNetworks/pcs-cspm-vulnerability-report/blob/main/.github/workflows/vulnerabilities-report.yml) in this repository.

## Environment Variables
The environment variables for the script are the following:

| Variable | Description | Default | Mandatory |
|-|-|-|-|
| PRISMA_USERNAME | Access Key of Service Account or name of the local user | N/A | Yes |
| PRISMA_PASSWORD | Secret Key of Service Account or name of the local user | N/A | Yes |
| PRISMA_API_ENDPOINT | [Prisma Cloud API Endpoint](https://pan.dev/prisma-cloud/api/cspm/api-urls/) | N/A | Yes |
| QUERY | vulnerabilities Query used for gathering the data. If you built your own customized vulnerability query, therefore you can get the text from your Recent Searches and use it to generate your own customized report | vulnerability where severity IN ( 'High', 'Critical' ) AND risk.factors CONTAINS ALL ( 'Exploitable', 'Patchable' ) | No |
| OWNER_TAG | Tag or Label used to identify the resource owner | owner | No |
| OUT_FILE | output file name | vulnerabilities_report.csv | No |
| NOT_FOUND | Resource not found JSON file | notFound.json | No |

## Requirements
For this script to run on your local machine, it is required to have python 3.10 or above installed

## Setup
### Step 1: Create Prisma Cloud Service Account
On Prisma Cloud create a Permissions Group with View only permissions to the following features:
- Assets Inventory
    - Overview

- Investigate
    - Vulnerability
    - Saved Searches

- Application Security
    - Projects

- Compute -> Monitor
    - Vulnerabilities Dashboard
    - Code Repositories Vulnerabilities & Compliance Results
    - Images/Containers Vulnerabilities & Compliance Results
    - Hosts Vulnerabilities & Compliance Results
    - Serverless & App-Embedded Vulnerabilities & Compliance Results

Once set create the corresponding role with all the account groups and repositories.

Once the role is set, create the corresponding Service Account.

### Step 2: Install requirements (local machine)
If you executing the script on your local machine, then it is required to install the dependencies with the following command:
```bash
pip install -r requirements.txt
```

Also it is recommended to install the *python-dotenv* package:
```bash
pip install python-dotenv
```

### Step 3: Create .env file (local machine)
If you executing the script on your local machine and installed the *python-dotenv* package, therefore you can create a file name *.env* and it must have the mandatory environment variables as the following:
```bash
PRISMA_API_ENDPOINT="https://api.prismacloud.io"
PRISMA_USERNAME="1111111"
PRISMA_PASSWORD="aaaaaaaaa"
```
You can also input any other environment variable listed above.

## Execute
To generate the report, just execute the following command:
```bash
python searchVulns.py
```

## Output
The report generated should have the same format as the file **vulnerabilities_report.csv** located in this repository.